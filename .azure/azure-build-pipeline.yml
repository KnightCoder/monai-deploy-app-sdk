trigger:
- main

pr:
- main

stages:
  - stage: 'Test'
    jobs:
    - job: RunTests
      pool:
        vmImage: ubuntu-20.04
      strategy:
        matrix:
          Python3.6:
            python.version: '3.6'
        maxParallel: 3
      steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: $(python.version)
        displayName: 'Setup Python'
      - script: |
          pip install virtualenv
          virtualenv .venv
        displayName: 'Create Venv'
      - script: |
          source .venv/bin/activate
          ./run setup
        displayName: 'Setup development environment'
      - script: |
          source .venv/bin/activate
          ./run check -f
        displayName: 'Check formatting'
      - script: |
          source .venv/bin/activate
          ./run test all unit
        displayName: 'Run Unit tests'
      - script: |
          # Refer to https://about.codecov.io/blog/introducing-codecovs-new-uploader/
          curl https://keybase.io/codecovsecurity/pgp_keys.asc | gpg --import # One-time step
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM
          curl -Os https://uploader.codecov.io/latest/linux/codecov.SHA256SUM.sig
          gpg --verify codecov.SHA256SUM.sig codecov.SHA256SUM
          shasum -a 256 -c codecov.SHA256SUM
          chmod +x codecov
          ./codecov -f monai-deploy-app-sdk-coverage.xml -t $(CODECOV_TOKEN)
        displayName: 'Upload code coverage'
